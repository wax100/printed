id: 21
source: 1
name: TicketForm
category: Tickets
properties: 'a:21:{s:13:"tplFormCreate";a:7:{s:4:"name";s:13:"tplFormCreate";s:4:"desc";s:26:"tickets_prop_tplFormCreate";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:23:"tpl.Tickets.form.create";s:7:"lexicon";s:18:"tickets:properties";s:4:"area";s:0:"";}s:13:"tplFormUpdate";a:7:{s:4:"name";s:13:"tplFormUpdate";s:4:"desc";s:26:"tickets_prop_tplFormUpdate";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:23:"tpl.Tickets.form.update";s:7:"lexicon";s:18:"tickets:properties";s:4:"area";s:0:"";}s:10:"tplPreview";a:7:{s:4:"name";s:10:"tplPreview";s:4:"desc";s:23:"tickets_prop_tplPreview";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:24:"tpl.Tickets.form.preview";s:7:"lexicon";s:18:"tickets:properties";s:4:"area";s:0:"";}s:13:"tplSectionRow";a:7:{s:4:"name";s:13:"tplSectionRow";s:4:"desc";s:26:"tickets_prop_tplSectionRow";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:69:"@INLINE <option value="[[+id]]" [[+selected]]>[[+pagetitle]]</option>";s:7:"lexicon";s:18:"tickets:properties";s:4:"area";s:0:"";}s:17:"tplTicketEmailBcc";a:7:{s:4:"name";s:17:"tplTicketEmailBcc";s:4:"desc";s:30:"tickets_prop_tplTicketEmailBcc";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:28:"tpl.Tickets.ticket.email.bcc";s:7:"lexicon";s:18:"tickets:properties";s:4:"area";s:0:"";}s:26:"tplTicketEmailSubscription";a:7:{s:4:"name";s:26:"tplTicketEmailSubscription";s:4:"desc";s:39:"tickets_prop_tplTicketEmailSubscription";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:37:"tpl.Tickets.ticket.email.subscription";s:7:"lexicon";s:18:"tickets:properties";s:4:"area";s:0:"";}s:13:"allowedFields";a:7:{s:4:"name";s:13:"allowedFields";s:4:"desc";s:26:"tickets_prop_allowedFields";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:24:"parent,pagetitle,content";s:7:"lexicon";s:18:"tickets:properties";s:4:"area";s:0:"";}s:14:"requiredFields";a:7:{s:4:"name";s:14:"requiredFields";s:4:"desc";s:27:"tickets_prop_requiredFields";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:24:"parent,pagetitle,content";s:7:"lexicon";s:18:"tickets:properties";s:4:"area";s:0:"";}s:12:"bypassFields";a:7:{s:4:"name";s:12:"bypassFields";s:4:"desc";s:25:"tickets_prop_bypassFields";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:0:"";s:7:"lexicon";s:18:"tickets:properties";s:4:"area";s:0:"";}s:19:"redirectUnpublished";a:7:{s:4:"name";s:19:"redirectUnpublished";s:4:"desc";s:32:"tickets_prop_redirectUnpublished";s:4:"type";s:11:"numberfield";s:7:"options";a:0:{}s:5:"value";i:0;s:7:"lexicon";s:18:"tickets:properties";s:4:"area";s:0:"";}s:7:"parents";a:7:{s:4:"name";s:7:"parents";s:4:"desc";s:29:"tickets_prop_sections_parents";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:0:"";s:7:"lexicon";s:18:"tickets:properties";s:4:"area";s:0:"";}s:9:"resources";a:7:{s:4:"name";s:9:"resources";s:4:"desc";s:31:"tickets_prop_sections_resources";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:0:"";s:7:"lexicon";s:18:"tickets:properties";s:4:"area";s:0:"";}s:11:"permissions";a:7:{s:4:"name";s:11:"permissions";s:4:"desc";s:33:"tickets_prop_sections_permissions";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:20:"section_add_children";s:7:"lexicon";s:18:"tickets:properties";s:4:"area";s:0:"";}s:6:"sortby";a:7:{s:4:"name";s:6:"sortby";s:4:"desc";s:28:"tickets_prop_sections_sortby";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:9:"pagetitle";s:7:"lexicon";s:18:"tickets:properties";s:4:"area";s:0:"";}s:7:"sortdir";a:7:{s:4:"name";s:7:"sortdir";s:4:"desc";s:29:"tickets_prop_sections_sortdir";s:4:"type";s:4:"list";s:7:"options";a:2:{i:0;a:2:{s:4:"text";s:3:"ASC";s:5:"value";s:3:"ASC";}i:1;a:2:{s:4:"text";s:4:"DESC";s:5:"value";s:4:"DESC";}}s:5:"value";s:3:"ASC";s:7:"lexicon";s:18:"tickets:properties";s:4:"area";s:0:"";}s:7:"context";a:7:{s:4:"name";s:7:"context";s:4:"desc";s:29:"tickets_prop_sections_context";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:0:"";s:7:"lexicon";s:18:"tickets:properties";s:4:"area";s:0:"";}s:10:"allowFiles";a:7:{s:4:"name";s:10:"allowFiles";s:4:"desc";s:23:"tickets_prop_allowFiles";s:4:"type";s:13:"combo-boolean";s:7:"options";a:0:{}s:5:"value";b:1;s:7:"lexicon";s:18:"tickets:properties";s:4:"area";s:0:"";}s:6:"source";a:7:{s:4:"name";s:6:"source";s:4:"desc";s:19:"tickets_prop_source";s:4:"type";s:11:"numberfield";s:7:"options";a:0:{}s:5:"value";i:0;s:7:"lexicon";s:18:"tickets:properties";s:4:"area";s:0:"";}s:8:"tplFiles";a:7:{s:4:"name";s:8:"tplFiles";s:4:"desc";s:21:"tickets_prop_tplFiles";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:22:"tpl.Tickets.form.files";s:7:"lexicon";s:18:"tickets:properties";s:4:"area";s:0:"";}s:7:"tplFile";a:7:{s:4:"name";s:7:"tplFile";s:4:"desc";s:20:"tickets_prop_tplFile";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:21:"tpl.Tickets.form.file";s:7:"lexicon";s:18:"tickets:properties";s:4:"area";s:0:"";}s:8:"tplImage";a:7:{s:4:"name";s:8:"tplImage";s:4:"desc";s:21:"tickets_prop_tplImage";s:4:"type";s:9:"textfield";s:7:"options";a:0:{}s:5:"value";s:22:"tpl.Tickets.form.image";s:7:"lexicon";s:18:"tickets:properties";s:4:"area";s:0:"";}}'
static_file: core/components/tickets/elements/snippets/snippet.ticket_form.php

-----

/* @var array $scriptProperties */
/* @var Tickets $Tickets */
$Tickets = $modx->getService('tickets', 'Tickets', $modx->getOption('tickets.core_path', null, $modx->getOption('core_path') . 'components/tickets/') . 'model/tickets/', $scriptProperties);
$Tickets->initialize($modx->context->key, $scriptProperties);

if (!$Tickets->authenticated) {
	return $modx->lexicon('ticket_err_no_auth');
}

$tplSectionRow = $modx->getOption('tplSectionRow', $scriptProperties, 'tpl.Tickets.sections.row');
$tplFormCreate = $modx->getOption('tplFormCreate', $scriptProperties, 'tpl.Tickets.form.create');
$tplFormUpdate = $modx->getOption('tplFormUpdate', $scriptProperties, 'tpl.Tickets.form.update');
$tplFiles = $modx->getOption('tplFiles', $scriptProperties, 'tpl.Tickets.form.files');
$tplFile = $Tickets->config['tplFile'] = $modx->getOption('tplFile', $scriptProperties, 'tpl.Tickets.form.file', true);
$tplImage = $Tickets->config['tplImage'] = $modx->getOption('tplImage', $scriptProperties, 'tpl.Tickets.form.image', true);
if (empty($source)) {
	$source = $Tickets->config['source'] = $modx->getOption('tickets.source_default', null, $modx->getOption('default_media_source'));
}
$tid = !empty($_REQUEST['tid'])
	? (int)$_REQUEST['tid']
	: 0;
$parent = !empty($_REQUEST['parent'])
	? $_REQUEST['parent']
	: '';
$data = array();

// Update of ticket
if (!empty($tid)) {
	$tplWrapper = $tplFormUpdate;
	/* @var Ticket $ticket */
	if ($ticket = $modx->getObject('Ticket', array('class_key' => 'Ticket', 'id' => $tid))) {
		if ($ticket->get('createdby') != $modx->user->id && !$modx->hasPermission('edit_document')) {
			return $modx->lexicon('ticket_err_wrong_user');
		}
		$charset = $modx->getOption('modx_charset');
		$allowedFields = array_map('trim', explode(',', $scriptProperties['allowedFields']));
		$allowedFields = array_unique(array_merge($allowedFields, array('parent', 'pagetitle', 'content')));

		$fields = array_keys($modx->getFieldMeta('Ticket'));
		foreach ($allowedFields as $field) {
			$value = in_array($field, $fields)
				? $ticket->get($field)
				: $ticket->getTVValue($field);
			if (is_string($value)) {
				$value = html_entity_decode($value, ENT_QUOTES, $charset);
				$value = str_replace(
					array('[^', '^]', '[', ']', '{', '}'),
					array('&#91;^', '^&#93;', '*(*(*(*(*(*', '*)*)*)*)*)*', '~(~(~(~(~(~', '~)~)~)~)~)~'),
					$value
				);
				$value = htmlentities($value, ENT_QUOTES, $charset);
			}
			$data[$field] = $value;
		}
		$data['id'] = $ticket->id;
		$data['published'] = $ticket->published;
		if (empty($parent)) {
			$parent = $ticket->get('parent');
		}
	}
	else {
		return $modx->lexicon('ticket_err_id', array('id' => $tid));
	}
}
else {
	$tplWrapper = $tplFormCreate;
}

// Get available sections for ticket create
$data['sections'] = '';
/** @var modProcessorResponse $response */
$response = $Tickets->runProcessor('web/section/getlist', array(
	'parents' => $scriptProperties['parents'],
	'resources' => $scriptProperties['resources'],
	'permissions' => $scriptProperties['permissions'],
	'sortby' => !empty($scriptProperties['sortby'])
		? $scriptProperties['sortby']
		: 'pagetitle',
	'sortdir' => !empty($scriptProperties['sortdir'])
		? $scriptProperties['sortdir']
		: 'asc',
	'depth' => isset($scriptProperties['depth'])
		? $scriptProperties['depth']
		: 0,
	'context' => !empty($scriptProperties['context'])
		? $scriptProperties['context']
		: $modx->context->key,
	'limit' => 0,
));
$response = $modx->fromJSON($response->getResponse());

if (!empty($response['results'])) {
	$Tickets->config['sections'] = array();
	foreach ($response['results'] as $v) {
		$v['selected'] = $parent == $v['id'] || $parent == $v['alias']
			? 'selected'
			: '';
		$data['sections'] .= $Tickets->getChunk($tplSectionRow, $v);
		$Tickets->config['sections'][] = $v['id'];
	}
}

if (!empty($allowFiles)) {
	$q = $modx->newQuery('TicketFile');
	$q->where(array('class' => 'Ticket'));
	$q->andCondition(array('parent' => 0, 'createdby' => $modx->user->id), null, 1);
	if (!empty($tid)) {
		$q->orCondition(array('parent' => $tid), null, 1);
	}
	$q->sortby('createdon', 'ASC');
	$collection = $modx->getIterator('TicketFile', $q);
	$files = '';
	/** @var TicketFile $item */
	foreach ($collection as $item) {
		if ($item->get('deleted') && !$item->get('parent')) {
			$item->remove();
		}
		else {
			$item = $item->toArray();
			$item['size'] = round($item['size'] / 1024, 2);
			$item['new'] = empty($item['parent']);
			$tpl = $item['type'] == 'image'
				? $tplImage
				: $tplFile;
			$files .= $Tickets->getChunk($tpl, $item);
		}
	}
	$data['files'] = $Tickets->getChunk($tplFiles, array(
		'files' => $files,
	));
	/** @var modMediaSource $source */
	if ($source = $modx->getObject('sources.modMediaSource', $source)) {
		$properties = $source->getPropertyList();
		$config = array(
			'size' => !empty($properties['maxUploadSize'])
				? $properties['maxUploadSize']
				: 3145728,
			'height' => !empty($properties['maxUploadHeight'])
				? $properties['maxUploadHeight']
				: 1080,
			'width' => !empty($properties['maxUploadWidth'])
				? $properties['maxUploadWidth']
				: 1920,
			'extensions' => !empty($properties['allowedFileTypes'])
				? $properties['allowedFileTypes']
				: 'jpg,jpeg,png,gif'
		);
		$modx->regClientStartupScript('<script type="text/javascript">TicketsConfig.source=' . $modx->toJSON($config) . '</script>', true);
	}
	$modx->regClientScript($Tickets->config['jsUrl'] . 'web/lib/plupload/plupload.full.min.js');
	$modx->regClientScript($Tickets->config['jsUrl'] . 'web/files.js');

	$lang = $modx->getOption('cultureKey');
	if ($lang != 'en' && file_exists($Tickets->config['jsPath'] . 'web/lib/plupload/i18n/' . $lang . '.js')) {
		$modx->regClientScript($Tickets->config['jsUrl'] . 'web/lib/plupload/i18n/' . $lang . '.js');
	}
}

$output = $Tickets->getChunk($tplWrapper, $data);
$key = md5($modx->toJSON($Tickets->config));
$_SESSION['TicketForm'][$key] = $Tickets->config;
$output = str_ireplace('</form>', "\n<input type=\"hidden\" name=\"form_key\" value=\"{$key}\" class=\"disable-sisyphus\" />\n</form>", $output);

return $output;